<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bona PRO | Á≥ªÁµ±Ë®∫Êñ∑Ê®°Âºè</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        :root { --b-gold: #CA8A04; --b-black: #050505; --b-zinc: #18181B; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--b-black); font-family: 'Noto Sans TC', sans-serif; color: #E2E8F0; width: 100vw; overscroll-behavior-y: none; }
        #root { height: 100%; width: 100%; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .bg-blueprint { position: fixed; inset: 0; z-index: -1; background-size: 30px 30px; background-image: linear-gradient(to right, rgba(202, 138, 4, 0.015) 1px, transparent 1px), linear-gradient(to bottom, rgba(202, 138, 4, 0.015) 1px, transparent 1px); pointer-events: none; }
        .main-scroll-container { flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; padding-bottom: 200px; width: 100%; }
        input, select { color-scheme: dark; background: #18181B; border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; font-size: 14px; width: 100%; outline: none; }
        #reader { width: 100%; border-radius: 24px; overflow: hidden; border: 1px solid rgba(202, 138, 4, 0.3); background: #000; min-height: 300px; }
        /* Âº∑Âà∂È°ØÁ§∫ÁöÑË®∫Êñ∑ÁõíÊ®£Âºè */
        .debug-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 9999; padding: 20px; overflow: auto; display: flex; flex-direction: column; }
        .debug-content { font-family: 'JetBrains Mono', monospace; color: #00ff00; white-space: pre-wrap; word-break: break-all; font-size: 12px; }
        .debug-toggle { position: fixed; bottom: 100px; right: 20px; z-index: 5000; background: #ef4444; color: white; padding: 10px; rounded-full; border: 2px solid white; box-shadow: 0 0 10px rgba(255,0,0,0.5); font-weight: bold; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="h-full">
    <div id="root" class="h-full"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const Icon = ({ name, size = 20, color = "currentColor" }) => <i key={name} data-lucide={name} style={{ width: size, height: size, color }}></i>;

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [loading, setLoading] = useState(false);
            const [isScanning, setIsScanning] = useState(false);
            const [showDebug, setShowDebug] = useState(false); // ÊéßÂà∂Ë®∫Êñ∑ÁõíÈ°ØÁ§∫
            const [logs, setLogs] = useState([]); // ÂÑ≤Â≠òÊó•Ë™å
            const [viewingIndividual, setViewingIndividual] = useState(null);
            
            // --- ÊéàÊ¨ä ---
            const [userId, setUserId] = useState(() => localStorage.getItem('bona_pro_license') || '');
            const [showLoginModal, setShowLoginModal] = useState(!localStorage.getItem('bona_pro_license'));

            const WEBHOOK_URL = "https://hook.us2.make.com/dft05gnm8d1nnhq1uw9owyy5rbon904w";
            // ÂòóË©¶ËºâÂÖ• logo.jpgÔºåËã•Â§±ÊïóÊúÉÈö±Ëóè
            const [logoError, setLogoError] = useState(false);

            const [prefix, setPrefix] = useState('PGK');
            const [serial, setSerial] = useState(Math.floor(Math.random() * 900) + 100);
            const [scannedID, setScannedID] = useState(null);
            const bonaID = useMemo(() => scannedID || `${prefix.toUpperCase()}-${new Date().getFullYear().toString().slice(-2)}-${serial}`, [prefix, serial, scannedID]);

            const [entry, setEntry] = useState({
                weight: '', subMain: 'BONAÊú®Â±ë', subSecondary: 'ÁÑ°', booster: 'ÁÑ°Ê∑ªÂä†',
                containerType: 'Â°ëËÜ†ÂúìÁ≠í', containerVolume: '1000ml',
                hatchDate: new Date().toISOString().split('T')[0], 
                checkDate: new Date().toISOString().split('T')[0],
                parentMaleSize: '', parentFemaleSize: '', generation: 'CBF1'
            });

            // ÂïüÂãï Lucide
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            // --- Êó•Ë™åÁ≥ªÁµ± ---
            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString();
                console.log(`[${time}] ${msg}`);
                setLogs(prev => [`[${time}] ${msg}`, ...prev]);
            };

            const handleLogin = () => {
                if(userId.trim()) {
                    localStorage.setItem('bona_pro_license', userId.trim());
                    setShowLoginModal(false);
                    addLog("ÁôªÂÖ•ÊàêÂäü: " + userId);
                }
            };

            // --- Ë®∫Êñ∑Áî® Fetch ---
            const fetchIndividualData = async (id) => {
                setLoading(true);
                addLog("üöÄ ÁôºÈÄÅË´ãÊ±ÇÁµ¶ Make.com...");
                addLog("Target ID: " + id);
                addLog("License: " + userId);
                
                try {
                    const res = await fetch(WEBHOOK_URL, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'query', id, license: userId })
                    });
                    
                    const responseText = await res.text();
                    addLog("üì• Êî∂Âà∞ Make ÂõûÊáâ:\n" + responseText);

                    let data;
                    try { data = JSON.parse(responseText); } catch(e) { throw new Error("ÂõûÂÇ≥Ë≥áÊñô‰∏çÊòØ JSON Ê†ºÂºè"); }

                    // ÂòóË©¶Â∞ãÊâæÊ≠∑Âè≤Á¥ÄÈåÑ
                    let historyRaw = data.raw || data.growthHistory || data;
                    if (typeof historyRaw === 'string') {
                        addLog("‚ö†Ô∏è ÂÅµÊ∏¨Âà∞Â≠ó‰∏≤Âåñ JSONÔºåÂòóË©¶‰∫åÊ¨°Ëß£Êûê...");
                        historyRaw = JSON.parse(historyRaw);
                    }

                    if (!Array.isArray(historyRaw) || historyRaw.length === 0) {
                        throw new Error("Ëß£ÊûêÂæåÁöÑË≥áÊñôÁÇ∫Á©∫ÔºåÊàñÊ†ºÂºè‰∏çÊ≠£Á¢∫ (Not an Array)"); 
                    }
                    
                    addLog(`‚úÖ ÊàêÂäüËß£Êûê ${historyRaw.length} Á≠ÜÊ≠∑Âè≤Á¥ÄÈåÑ`);

                    // Ëê¨Áî®ÂèñÂÄº
                    const getValue = (item, keys) => {
                        const paths = [keys, keys.toLowerCase(), `properties value.${keys}.number`, `properties value.${keys}.select.name`, `properties.${keys}.number`];
                        for (let path of paths) {
                            const val = path.split('.').reduce((acc, part) => acc && acc[part], item);
                            if (val !== undefined && val !== null) return val;
                        }
                        return null;
                    };

                    const history = historyRaw.map(item => ({
                        date: getValue(item, 'Date_Check') || getValue(item, 'date'),
                        weight: getValue(item, 'Weight') || getValue(item, 'weight'),
                        sub: getValue(item, 'Sub_Main') || getValue(item, 'sub')
                    })).filter(i => i.date);

                    if (history.length === 0) throw new Error("ÈÅéÊøæÂæåÁÑ°ÊúâÊïàÊó•ÊúüË≥áÊñô");
                    
                    history.sort((a, b) => new Date(a.date) - new Date(b.date));
                    const latest = history[history.length - 1];

                    setViewingIndividual({
                        id: id,
                        currentWeight: latest.weight,
                        growthHistory: history,
                        // ÂòóË©¶ÊäìÂèñË°ÄÁµ±
                        parentMaleSize: getValue(history[0], 'Sire_Size') || '-',
                        parentFemaleSize: getValue(history[0], 'Dam_Size') || '-',
                        generation: getValue(history[0], 'Generation') || '-'
                    });
                    
                    setScannedID(id);
                    setLoading(false);
                    setActiveTab('detail');
                    addLog("‚úÖ ÊàêÂäüÈÄ≤ÂÖ•Ê™¢Ë¶ñÊ®°Âºè");
                    // Ëá™ÂãïÈñãÂïü Debug Ë¶ñÁ™ó 3ÁßíËÆìÁî®Êà∂ÁúãÂà∞ÁµêÊûú
                    setShowDebug(true);
                    setTimeout(() => setShowDebug(false), 3000);

                } catch (e) { 
                    setLoading(false);
                    addLog("‚ùå ÈåØË™§: " + e.message);
                    addLog("‚ö†Ô∏è Á≥ªÁµ±Âà§ÂÆöÁÇ∫Êñ∞ÂÄãÈ´îÔºåÈÄ≤ÂÖ•„ÄêË£úÁôªÊ®°Âºè„Äë");
                    setShowDebug(true); // ÈåØË™§ÊôÇÂº∑Âà∂È°ØÁ§∫ Debug
                    setViewingIndividual(null);
                    setScannedID(id);
                    setActiveTab('entry'); 
                }
            };

            // --- ÊéÉÊèèÂô® ---
            useEffect(() => {
                if (!isScanning) return;
                addLog("üì∑ Ê≠£Âú®ÂïüÂãïÁõ∏Ê©ü...");
                const timer = setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                        let finalId = decodedText.includes('/scan/') ? decodedText.split('/scan/').pop().split('?')[0] : decodedText;
                        addLog("‚úÖ ÊéÉÊèèÊàêÂäü: " + finalId);
                        setIsScanning(false);
                        html5QrCode.stop().then(() => fetchIndividualData(finalId.toUpperCase()));
                    }).catch(err => {
                        addLog("‚ùå Áõ∏Ê©üÂïüÂãïÂ§±Êïó: " + err);
                        setIsScanning(false);
                        setShowDebug(true);
                    });
                }, 500);
                return () => clearTimeout(timer);
            }, [isScanning]);

            // --- Âº∑Âà∂ÂêåÊ≠•‰øÆÂæ© ---
            const handleSync = async () => {
                if (!entry.weight) return alert("Ë´ãËº∏ÂÖ•È´îÈáç");
                setLoading(true);
                addLog("üöÄ ÈñãÂßãÂêåÊ≠•Êï∏Êìö...");
                try {
                    const payload = { 
                        type: 'growth', 
                        license: userId,
                        id: bonaID, 
                        mode: viewingIndividual ? 'update' : 'new', 
                        weight: parseFloat(entry.weight), 
                        checkDate: entry.checkDate,
                        hatchDate: entry.hatchDate,
                        subMain: entry.subMain,
                        subSecondary: entry.subSecondary,
                        containerType: entry.containerType,
                        containerVolume: entry.containerVolume,
                        booster: entry.booster,
                        parentMaleSize: entry.parentMaleSize,
                        parentFemaleSize: entry.parentFemaleSize,
                        generation: entry.generation,
                        timestamp: new Date().toISOString() 
                    };
                    
                    addLog("Payload: " + JSON.stringify(payload));

                    const res = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (res.ok) {
                        setSaveStatus('success');
                        addLog("‚úÖ ÂêåÊ≠•ÊàêÂäüÔºÅ");
                        setTimeout(() => { 
                            setSaveStatus('idle'); setLoading(false); setActiveTab('home'); 
                            setViewingIndividual(null); setScannedID(null); setEntry(prev => ({...prev, weight: ''})); 
                        }, 2000);
                    } else throw new Error("API Error");
                } catch (e) { setLoading(false); addLog("‚ùå ‰∏äÂÇ≥Â§±Êïó: " + e.message); setShowDebug(true); }
            };

            // --- ‰ªãÈù¢Ê∏≤Êüì ---
            if (showLoginModal) return (
                <div className="h-full flex items-center justify-center p-8 bg-black">
                    <div className="w-full max-w-sm text-center space-y-4">
                        {!logoError ? (
                            <img src="logo.jpg" className="w-24 h-24 mx-auto rounded-2xl mb-4 border border-white/10" onError={() => setLogoError(true)} />
                        ) : (
                            <div className="text-4xl mb-4">ü™≤</div>
                        )}
                        <h2 className="text-2xl font-black text-white">Bona Terminal</h2>
                        <input type="text" placeholder="LICENSE KEY" value={userId} onChange={e=>setUserId(e.target.value)} className="text-center font-mono text-[#CA8A04]" />
                        <button onClick={handleLogin} className="w-full bg-[#CA8A04] text-black font-black py-4 rounded-xl">LOGIN</button>
                    </div>
                </div>
            );

            return (
                <div className="h-full flex flex-col bg-black text-white relative">
                    <div className="bg-blueprint"></div>
                    
                    {/* Âº∑Âà∂Ë®∫Êñ∑ÊåâÈàï */}
                    <button onClick={() => setShowDebug(!showDebug)} className="debug-toggle">üêû</button>

                    {/* Ë®∫Êñ∑Ë®äÊÅØÊ°Ü */}
                    {showDebug && (
                        <div className="debug-overlay">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-[#CA8A04] font-black">SYSTEM LOGS</h3>
                                <button onClick={()=>setShowDebug(false)} className="bg-zinc-800 px-4 py-2 rounded text-xs">CLOSE</button>
                            </div>
                            <div className="debug-content">
                                {logs.map((log, i) => <div key={i} className="mb-2 border-b border-white/10 pb-1">{log}</div>)}
                            </div>
                        </div>
                    )}

                    {loading && <div className="fixed inset-0 z-[1500] bg-black/90 flex items-center justify-center"><div className="text-[#CA8A04] font-black animate-pulse">PROCESSING...</div></div>}
                    
                    {saveStatus === 'success' && <div className="fixed inset-0 z-[1500] bg-black/90 flex items-center justify-center"><div className="text-green-500 font-black text-2xl">SUCCESS</div></div>}

                    {isScanning && <div className="fixed inset-0 z-[1100] bg-black p-6 flex flex-col justify-center"><div id="reader"></div><button onClick={()=>setIsScanning(false)} className="mt-8 bg-zinc-800 py-4 rounded-xl font-black">CANCEL</button></div>}

                    <main className="main-scroll-container px-6 pt-12">
                        <header className="flex justify-between items-center mb-8">
                            <div className="space-y-1"><p className="text-[10px] text-green-500">‚óè {userId}</p><h2 className="text-2xl font-black italic">Bona_Terminal</h2></div>
                            <button onClick={()=>{localStorage.removeItem('bona_pro_license');window.location.reload()}}><i data-lucide="log-out"></i></button>
                        </header>

                        {activeTab === 'home' && (
                            <div className="space-y-4">
                                <div className="bg-gradient-to-br from-[#CA8A04] to-yellow-800 p-8 rounded-[2.5rem] text-black shadow-xl active:scale-95 transition-all" onClick={() => setIsScanning(true)}>
                                    <i data-lucide="scan" className="w-8 h-8 mb-4"></i>
                                    <h3 className="text-2xl font-black italic">SCAN / ÊéÉÊèè</h3>
                                    <p className="text-xs font-bold opacity-80 mt-1">Ê™¢Á¥¢ËàáÊõ¥Êñ∞ÂÄãÈ´î</p>
                                </div>
                                <div className="bg-zinc-900 border border-white/10 p-8 rounded-[2.5rem] active:scale-95 transition-all" onClick={() => { setActiveTab('entry'); setScannedID(null); setViewingIndividual(null); }}>
                                    <i data-lucide="plus" className="w-8 h-8 mb-4 text-[#CA8A04]"></i>
                                    <h3 className="text-2xl font-black italic">NEW / Êñ∞ÂëΩ</h3>
                                    <p className="text-xs text-zinc-500 font-bold mt-1">Âª∫Á´ãÊñ∞Ê™îÊ°à</p>
                                </div>
                            </div>
                        )}

                        {(activeTab === 'detail' || activeTab === 'entry') && (
                            <div className="space-y-6 pb-20">
                                <button onClick={()=>setActiveTab('home')} className="bg-zinc-900 p-3 rounded-xl mb-4"><i data-lucide="arrow-left"></i></button>
                                
                                <div className="glass-card p-6 rounded-[2rem]">
                                    <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">TARGET ID</p>
                                    <h2 className="text-3xl font-black text-white font-mono">{bonaID}</h2>
                                    {activeTab === 'entry' && <button onClick={()=>setSerial(Math.floor(Math.random()*900)+100)} className="mt-2 text-xs text-[#CA8A04] border border-[#CA8A04] px-3 py-1 rounded-full">ÈáçÁΩÆ ID</button>}
                                </div>

                                {viewingIndividual && (
                                    <div className="glass-card p-6 rounded-[2rem] space-y-4">
                                        <div className="flex justify-between items-end border-b border-white/10 pb-4">
                                            <div><p className="text-[9px] text-zinc-500">CURRENT MASS</p><p className="text-4xl font-black">{viewingIndividual.currentWeight}g</p></div>
                                            <div className="text-right"><p className="text-[9px] text-zinc-500">GEN</p><p className="text-xl font-bold text-[#CA8A04]">{viewingIndividual.generation}</p></div>
                                        </div>
                                        <div className="space-y-2 max-h-40 overflow-y-auto">
                                            {viewingIndividual.growthHistory.map((h,i) => (
                                                <div key={i} className="flex justify-between text-xs font-mono text-zinc-400">
                                                    <span>{h.date}</span><span>{h.sub}</span><span className="text-white font-bold">{h.weight}g</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="bg-[#18181B] p-6 rounded-[2.5rem] border border-[#CA8A04]/20 space-y-6">
                                    <div className="text-center">
                                        <p className="text-[10px] text-[#CA8A04] font-bold mb-2">INPUT WEIGHT (G)</p>
                                        <input type="number" value={entry.weight} onChange={e=>setEntry({...entry, weight: e.target.value})} className="bg-transparent text-5xl font-black text-white text-center outline-none w-40 mx-auto border-b border-white/20 focus:border-[#CA8A04]" placeholder="0.0" />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[9px] text-zinc-500 ml-1">Êó•Êúü</label><input type="date" value={entry.checkDate} onChange={e=>setEntry({...entry, checkDate: e.target.value})} /></div>
                                        <div><label className="text-[9px] text-zinc-500 ml-1">Ê∑ªÂä†Âäë</label><select value={entry.booster} onChange={e=>setEntry({...entry, booster: e.target.value})}>{["ÁÑ°Ê∑ªÂä†", "10g/10L", "20g/10L", "Ê•µÈôêÁµÑ"].map(o=><option key={o}>{o}</option>)}</select></div>
                                    </div>

                                    {!viewingIndividual && (
                                        <div className="space-y-3 pt-4 border-t border-white/10">
                                            <p className="text-[10px] text-zinc-500 font-bold">GENETICS INFO (ÂøÖÂ°´)</p>
                                            <div className="grid grid-cols-2 gap-3">
                                                <input type="text" placeholder="Sire ‚ôÇ" value={entry.parentMaleSize} onChange={e=>setEntry({...entry, parentMaleSize: e.target.value})} />
                                                <input type="text" placeholder="Dam ‚ôÄ" value={entry.parentFemaleSize} onChange={e=>setEntry({...entry, parentFemaleSize: e.target.value})} />
                                            </div>
                                            <input type="text" placeholder="Generation (Á¥Ø‰ª£)" value={entry.generation} onChange={e=>setEntry({...entry, generation: e.target.value})} />
                                        </div>
                                    )}

                                    <div className="grid grid-cols-2 gap-3 pt-2">
                                        <select value={entry.subMain} onChange={e=>setEntry({...entry, subMain: e.target.value})}>{SUBSTRATES.map(o=><option key={o}>{o}</option>)}</select>
                                        <select value={entry.subSecondary} onChange={e=>setEntry({...entry, subSecondary: e.target.value})}>{SUBSTRATES.map(o=><option key={o}>{o}</option>)}</select>
                                        <select value={entry.containerType} onChange={e=>setEntry({...entry, containerType: e.target.value})}>{CONTAINERS.map(o=><option key={o}>{o}</option>)}</select>
                                        <select value={entry.containerVolume} onChange={e=>setEntry({...entry, containerVolume: e.target.value})}>{VOLUMES.map(o=><option key={o}>{o}</option>)}</select>
                                    </div>

                                    <button onClick={()=>handleSync('growth')} className="w-full bg-[#CA8A04] text-black font-black py-5 rounded-2xl text-xs tracking-widest shadow-xl active:scale-95 transition-all">
                                        {viewingIndividual ? 'UPDATE RECORD' : 'CREATE NEW FILE'}
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>