<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bona PRO | 系統診斷模式</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="logo.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        :root { --b-gold: #CA8A04; --b-black: #050505; --b-zinc: #18181B; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--b-black); font-family: 'Noto Sans TC', sans-serif; color: #E2E8F0; width: 100vw; overscroll-behavior-y: none; }
        #root { height: 100%; width: 100%; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .bg-blueprint { position: fixed; inset: 0; z-index: -1; background-size: 30px 30px; background-image: linear-gradient(to right, rgba(202, 138, 4, 0.015) 1px, transparent 1px), linear-gradient(to bottom, rgba(202, 138, 4, 0.015) 1px, transparent 1px); pointer-events: none; }
        .main-scroll-container { flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; padding-bottom: 200px; width: 100%; }
        input, select { color-scheme: dark; background: #18181B; border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; font-size: 14px; width: 100%; outline: none; }
        #reader { width: 100%; border-radius: 24px; overflow: hidden; border: 1px solid rgba(202, 138, 4, 0.3); background: #000; min-height: 300px; }
        .debug-box { background: #000; border: 1px solid #00ff00; color: #00ff00; font-family: monospace; padding: 10px; font-size: 10px; overflow-x: auto; white-space: pre-wrap; margin-top: 10px; border-radius: 8px; }
    </style>
</head>
<body class="h-full">
    <div id="root" class="h-full"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const Icon = ({ name, size = 20, color = "currentColor" }) => <i key={name} data-lucide={name} style={{ width: size, height: size, color }}></i>;

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [loading, setLoading] = useState(false);
            const [isScanning, setIsScanning] = useState(false);
            const [debugLog, setDebugLog] = useState(null); // 診斷日誌
            const [viewingIndividual, setViewingIndividual] = useState(null);
            
            // --- 授權 ---
            const [userId, setUserId] = useState(() => localStorage.getItem('bona_pro_license') || '');
            const [showLoginModal, setShowLoginModal] = useState(!localStorage.getItem('bona_pro_license'));

            const WEBHOOK_URL = "https://hook.us2.make.com/dft05gnm8d1nnhq1uw9owyy5rbon904w";
            const logoUrl = "logo.jpg";

            const [prefix, setPrefix] = useState('PGK');
            const [serial, setSerial] = useState(Math.floor(Math.random() * 900) + 100);
            const [scannedID, setScannedID] = useState(null);
            const bonaID = useMemo(() => scannedID || `${prefix.toUpperCase()}-${new Date().getFullYear().toString().slice(-2)}-${serial}`, [prefix, serial, scannedID]);

            const [entry, setEntry] = useState({
                weight: '', subMain: 'BONA木屑', subSecondary: '無', booster: '無添加',
                containerType: '塑膠圓筒', containerVolume: '1000ml',
                hatchDate: new Date().toISOString().split('T')[0], 
                checkDate: new Date().toISOString().split('T')[0],
                parentMaleSize: '', parentFemaleSize: '', generation: 'CBF1'
            });

            // 啟動 Lucide Icons
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const handleLogin = () => {
                if(userId.trim()) {
                    localStorage.setItem('bona_pro_license', userId.trim());
                    setShowLoginModal(false);
                }
            };

            // --- 診斷用 Fetch ---
            const fetchIndividualData = async (id) => {
                setLoading(true);
                setDebugLog("開始連線 Make... ID: " + id);
                try {
                    const res = await fetch(WEBHOOK_URL, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'query', id, license: userId })
                    });
                    
                    const responseText = await res.text();
                    console.log("Raw Response:", responseText);
                    setDebugLog("Make 回傳原始數據:\n" + responseText); // 顯示在螢幕上

                    let data;
                    try { data = JSON.parse(responseText); } catch(e) { throw new Error("JSON 解析失敗"); }

                    // 嘗試尋找歷史紀錄
                    let historyRaw = data.raw || data.growthHistory || data;
                    if (typeof historyRaw === 'string') historyRaw = JSON.parse(historyRaw);

                    if (!Array.isArray(historyRaw) || historyRaw.length === 0) {
                        throw new Error("抓到了數據但格式不是陣列或為空"); 
                    }

                    // 萬用取值
                    const getValue = (item, keys) => {
                        const paths = [keys, keys.toLowerCase(), `properties value.${keys}.number`, `properties value.${keys}.select.name`, `properties.${keys}.number`];
                        for (let path of paths) {
                            const val = path.split('.').reduce((acc, part) => acc && acc[part], item);
                            if (val !== undefined && val !== null) return val;
                        }
                        return null;
                    };

                    const history = historyRaw.map(item => ({
                        date: getValue(item, 'Date_Check') || getValue(item, 'date'),
                        weight: getValue(item, 'Weight') || getValue(item, 'weight'),
                        sub: getValue(item, 'Sub_Main') || getValue(item, 'sub')
                    })).filter(i => i.date);

                    if (history.length === 0) throw new Error("解析後無有效歷史紀錄");
                    
                    history.sort((a, b) => new Date(a.date) - new Date(b.date));
                    const latest = history[history.length - 1];

                    setViewingIndividual({
                        id: id,
                        currentWeight: latest.weight,
                        growthHistory: history,
                        // 嘗試抓取血統
                        parentMaleSize: getValue(history[0], 'Sire_Size') || '-',
                        parentFemaleSize: getValue(history[0], 'Dam_Size') || '-',
                        generation: getValue(history[0], 'Generation') || '-'
                    });
                    
                    setScannedID(id);
                    setLoading(false);
                    setActiveTab('detail');

                } catch (e) { 
                    setLoading(false);
                    setDebugLog(prev => prev + "\n\n❌ 錯誤: " + e.message + "\n系統將進入【補登模式】");
                    // 即使失敗也進入錄入，但保留 Log 給用戶看
                    setViewingIndividual(null);
                    setScannedID(id);
                    setActiveTab('entry'); 
                }
            };

            // --- 掃描器 ---
            useEffect(() => {
                if (!isScanning) return;
                const timer = setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                        let finalId = decodedText.includes('/scan/') ? decodedText.split('/scan/').pop().split('?')[0] : decodedText;
                        setIsScanning(false);
                        html5QrCode.stop().then(() => fetchIndividualData(finalId.toUpperCase()));
                    }).catch(err => setDebugLog("相機啟動失敗: " + err));
                }, 500);
                return () => clearTimeout(timer);
            }, [isScanning]);

            // --- 強制同步修復 ---
            const handleSync = async () => {
                if (!entry.weight) return alert("請輸入體重");
                setLoading(true);
                try {
                    // 強制轉換數字，避免 Notion 拒收字串
                    const payload = { 
                        type: 'growth', 
                        license: userId,
                        id: bonaID, 
                        mode: viewingIndividual ? 'update' : 'new', // 有舊資料=update, 無=new
                        weight: parseFloat(entry.weight), // ★ 關鍵：強制轉數字
                        checkDate: entry.checkDate,
                        hatchDate: entry.hatchDate,
                        subMain: entry.subMain,
                        subSecondary: entry.subSecondary,
                        containerType: entry.containerType,
                        containerVolume: entry.containerVolume,
                        booster: entry.booster,
                        parentMaleSize: entry.parentMaleSize, // 這些欄位只有 mode=new 時 Make 才會寫入
                        parentFemaleSize: entry.parentFemaleSize,
                        generation: entry.generation,
                        timestamp: new Date().toISOString() 
                    };
                    
                    setDebugLog("正在上傳資料:\n" + JSON.stringify(payload, null, 2));

                    const res = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (res.ok) {
                        setSaveStatus('success');
                        setTimeout(() => { 
                            setSaveStatus('idle'); setLoading(false); setActiveTab('home'); 
                            setViewingIndividual(null); setScannedID(null); setEntry(prev => ({...prev, weight: ''})); setDebugLog(null);
                        }, 2000);
                    } else throw new Error("API Error");
                } catch (e) { setLoading(false); setDebugLog("上傳失敗: " + e.message); }
            };

            // --- 介面渲染 ---
            if (showLoginModal) return (
                <div className="h-full flex items-center justify-center p-8 bg-black">
                    <div className="w-full max-w-sm text-center space-y-4">
                        <h2 className="text-2xl font-black text-white">Bona Terminal</h2>
                        <input type="text" placeholder="LICENSE KEY" value={userId} onChange={e=>setUserId(e.target.value)} className="text-center font-mono text-[#CA8A04]" />
                        <button onClick={handleLogin} className="w-full bg-[#CA8A04] text-black font-black py-4 rounded-xl">LOGIN</button>
                    </div>
                </div>
            );

            return (
                <div className="h-full flex flex-col bg-black text-white relative">
                    <div className="bg-blueprint"></div>
                    
                    {/* 診斷訊息框 (只在有錯誤或 loading 時顯示) */}
                    {debugLog && <div className="fixed top-0 left-0 right-0 z-[2000] p-4 bg-black/90"><div className="debug-box">{debugLog}</div><button onClick={()=>setDebugLog(null)} className="text-xs text-white mt-2 border p-1">關閉 Log</button></div>}

                    {loading && <div className="fixed inset-0 z-[1500] bg-black/90 flex items-center justify-center"><div className="text-[#CA8A04] font-black animate-pulse">PROCESSING...</div></div>}
                    
                    {saveStatus === 'success' && <div className="fixed inset-0 z-[1500] bg-black/90 flex items-center justify-center"><div className="text-green-500 font-black text-2xl">SUCCESS</div></div>}

                    {isScanning && <div className="fixed inset-0 z-[1100] bg-black p-6 flex flex-col justify-center"><div id="reader"></div><button onClick={()=>setIsScanning(false)} className="mt-8 bg-zinc-800 py-4 rounded-xl font-black">CANCEL</button></div>}

                    <main className="main-scroll-container px-6 pt-12">
                        <header className="flex justify-between items-center mb-8">
                            <div className="space-y-1"><p className="text-[10px] text-green-500">● {userId}</p><h2 className="text-2xl font-black italic">Bona_Terminal</h2></div>
                            <button onClick={()=>{localStorage.removeItem('bona_pro_license');window.location.reload()}}><i data-lucide="log-out"></i></button>
                        </header>

                        {activeTab === 'home' && (
                            <div className="space-y-4">
                                <div className="bg-gradient-to-br from-[#CA8A04] to-yellow-800 p-8 rounded-[2.5rem] text-black shadow-xl active:scale-95 transition-all" onClick={() => setIsScanning(true)}>
                                    <i data-lucide="scan" className="w-8 h-8 mb-4"></i>
                                    <h3 className="text-2xl font-black italic">SCAN / 掃描</h3>
                                    <p className="text-xs font-bold opacity-80 mt-1">檢索與更新個體</p>
                                </div>
                                <div className="bg-zinc-900 border border-white/10 p-8 rounded-[2.5rem] active:scale-95 transition-all" onClick={() => { setActiveTab('entry'); setScannedID(null); setViewingIndividual(null); }}>
                                    <i data-lucide="plus" className="w-8 h-8 mb-4 text-[#CA8A04]"></i>
                                    <h3 className="text-2xl font-black italic">NEW / 新命</h3>
                                    <p className="text-xs text-zinc-500 font-bold mt-1">建立新檔案</p>
                                </div>
                            </div>
                        )}

                        {(activeTab === 'detail' || activeTab === 'entry') && (
                            <div className="space-y-6 pb-20">
                                <button onClick={()=>setActiveTab('home')} className="bg-zinc-900 p-3 rounded-xl mb-4"><i data-lucide="arrow-left"></i></button>
                                
                                {/* ID 顯示區 */}
                                <div className="glass-card p-6 rounded-[2rem]">
                                    <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">TARGET ID</p>
                                    <h2 className="text-3xl font-black text-white font-mono">{bonaID}</h2>
                                    {/* 如果是補登模式 (activeTab=entry)，顯示重置按鈕 */}
                                    {activeTab === 'entry' && <button onClick={()=>setSerial(Math.floor(Math.random()*900)+100)} className="mt-2 text-xs text-[#CA8A04] border border-[#CA8A04] px-3 py-1 rounded-full">重置 ID</button>}
                                </div>

                                {/* 歷史紀錄 (只在檢視模式顯示) */}
                                {viewingIndividual && (
                                    <div className="glass-card p-6 rounded-[2rem] space-y-4">
                                        <div className="flex justify-between items-end border-b border-white/10 pb-4">
                                            <div><p className="text-[9px] text-zinc-500">CURRENT MASS</p><p className="text-4xl font-black">{viewingIndividual.currentWeight}g</p></div>
                                            <div className="text-right"><p className="text-[9px] text-zinc-500">GEN</p><p className="text-xl font-bold text-[#CA8A04]">{viewingIndividual.generation}</p></div>
                                        </div>
                                        <div className="space-y-2 max-h-40 overflow-y-auto">
                                            {viewingIndividual.growthHistory.map((h,i) => (
                                                <div key={i} className="flex justify-between text-xs font-mono text-zinc-400">
                                                    <span>{h.date}</span><span>{h.sub}</span><span className="text-white font-bold">{h.weight}g</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* 錄入/更新表單 */}
                                <div className="bg-[#18181B] p-6 rounded-[2.5rem] border border-[#CA8A04]/20 space-y-6">
                                    <div className="text-center">
                                        <p className="text-[10px] text-[#CA8A04] font-bold mb-2">INPUT WEIGHT (G)</p>
                                        <input type="number" value={entry.weight} onChange={e=>setEntry({...entry, weight: e.target.value})} className="bg-transparent text-5xl font-black text-white text-center outline-none w-40 mx-auto border-b border-white/20 focus:border-[#CA8A04]" placeholder="0.0" />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[9px] text-zinc-500 ml-1">日期</label><input type="date" value={entry.checkDate} onChange={e=>setEntry({...entry, checkDate: e.target.value})} /></div>
                                        <div><label className="text-[9px] text-zinc-500 ml-1">添加劑</label><select value={entry.booster} onChange={e=>setEntry({...entry, booster: e.target.value})}>{["無添加", "10g/10L", "20g/10L", "極限組"].map(o=><option key={o}>{o}</option>)}</select></div>
                                    </div>

                                    {/* 只有新命錄入(或補登)才顯示親代欄位 */}
                                    {!viewingIndividual && (
                                        <div className="space-y-3 pt-4 border-t border-white/10">
                                            <p className="text-[10px] text-zinc-500 font-bold">GENETICS INFO (必填)</p>
                                            <div className="grid grid-cols-2 gap-3">
                                                <input type="text" placeholder="Sire ♂" value={entry.parentMaleSize} onChange={e=>setEntry({...entry, parentMaleSize: e.target.value})} />
                                                <input type="text" placeholder="Dam ♀" value={entry.parentFemaleSize} onChange={e=>setEntry({...entry, parentFemaleSize: e.target.value})} />
                                            </div>
                                            <input type="text" placeholder="Generation (累代)" value={entry.generation} onChange={e=>setEntry({...entry, generation: e.target.value})} />
                                        </div>
                                    )}

                                    <div className="grid grid-cols-2 gap-3 pt-2">
                                        <select value={entry.subMain} onChange={e=>setEntry({...entry, subMain: e.target.value})}>{SUBSTRATES.map(o=><option key={o}>{o}</option>)}</select>
                                        <select value={entry.containerVolume} onChange={e=>setEntry({...entry, containerVolume: e.target.value})}>{VOLUMES.map(o=><option key={o}>{o}</option>)}</select>
                                    </div>

                                    <button onClick={()=>handleSync('growth')} className="w-full bg-[#CA8A04] text-black font-black py-5 rounded-2xl text-xs tracking-widest shadow-xl active:scale-95 transition-all">
                                        {viewingIndividual ? 'UPDATE RECORD' : 'CREATE NEW FILE'}
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>